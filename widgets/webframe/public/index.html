<html>
  <head>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      
      #proxy-iframe {
        width: 100%;
        height: 100vh;
        border: none;
      }
      
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        height: 100vh;
        font-family: sans-serif;
        color: #666;
      }
      
      .loading-text {
        margin-top: 10px;
        font-size: 14px;
      }
      
      .error {
        padding: 20px;
        color: #d32f2f;
        font-family: sans-serif;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body class="homey-widget">
    <div class="loading">
      <div>Loading...</div>
      <div class="loading-text" id="status"></div>
    </div>
    <iframe id="proxy-iframe" style="display: none;" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
    
    <script type="text/javascript">
      function onHomeyReady(Homey) {
        Homey.ready();

        const url = Homey.getSettings().url;
        if (!url) {
          document.body.innerHTML = '<div class="error">Please configure a URL in the widget settings</div>';
          return;
        }

        const iframe = document.getElementById('proxy-iframe');
        const loading = document.querySelector('.loading');
        const statusEl = document.getElementById('status');
        
        function updateStatus(msg) {
          console.log(msg);
          statusEl.textContent = msg;
        }

        // Proxy function to make requests through Homey API
        async function proxyRequest(requestUrl, method = 'GET', headers = {}, data = null) {
          console.log('Making proxy request to:', requestUrl);
          
          try {
            const result = await Homey.api("POST", "/request", {
              url: requestUrl,
              method: method,
              headers: headers,
              data: data
            });
            
            console.log('Received response:', {
              success: result.success,
              status: result.status,
              contentType: result.contentType,
              dataLength: result.data ? result.data.length : 0
            });
            
            if (result.success === false) {
              throw new Error(result.error || 'Request failed');
            }
            
            return result;
          } catch (err) {
            console.error('Homey API error:', err);
            throw err;
          }
        }

        // Better base64 decode that handles Unicode
        function base64DecodeUnicode(base64) {
          try {
            const binaryString = atob(base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            return new TextDecoder('utf-8').decode(bytes);
          } catch (e) {
            console.error('Failed to decode base64:', e);
            return atob(base64);
          }
        }

        // Parse meta refresh tag from HTML
        function parseMetaRefresh(html, baseUrl) {
          const metaRefreshRegex = /<meta\s+http-equiv=["']refresh["']\s+content=["'](\d+);\s*url=([^"']+)["']\s*\/?>/i;
          const match = html.match(metaRefreshRegex);
          
          if (match) {
            const delay = parseInt(match[1], 10) || 0;
            let targetUrl = match[2].trim();
            
            try {
              targetUrl = new URL(targetUrl, baseUrl).href;
            } catch (e) {
              console.error('Failed to parse meta refresh URL:', e);
              return null;
            }
            
            console.log('Found meta refresh:', { delay, targetUrl });
            return { delay, targetUrl };
          }
          
          return null;
        }

        async function loadPage() {
          await loadPageFromUrl(url);
        }

        async function loadPageFromUrl(pageUrl) {
          try {
            updateStatus('Fetching page...');
            const result = await proxyRequest(pageUrl);
            
            updateStatus('Processing HTML...');
            console.log('Content type:', result.contentType);
            
            let htmlContent;
            try {
              htmlContent = base64DecodeUnicode(result.data);
              console.log('Decoded HTML length:', htmlContent.length);
            } catch (decodeError) {
              console.error('Decode error:', decodeError);
              throw new Error('Failed to decode response: ' + decodeError.message);
            }
            
            // Check for meta refresh
            const metaRefresh = parseMetaRefresh(htmlContent, pageUrl);
            if (metaRefresh) {
              console.log('Meta refresh detected, redirecting in', metaRefresh.delay, 'ms to', metaRefresh.targetUrl);
              updateStatus(`Redirecting in ${metaRefresh.delay}ms...`);
              
              setTimeout(() => {
                loadPageFromUrl(metaRefresh.targetUrl);
              }, metaRefresh.delay * 1000);
              
              return;
            }
            
            // Process HTML
            console.log('Injecting proxy script');
            const processed = injectProxyIntoHtml(htmlContent, pageUrl);
            console.log('Processed HTML length:', processed.length);
            
            updateStatus('Loading into frame...');
            
            iframe.srcdoc = processed;
            
            iframe.onload = function() {
              console.log('Iframe loaded');
              loading.style.display = 'none';
              iframe.style.display = 'block';
              updateStatus('Ready');
              
              // Start loading resources after iframe is ready
              setTimeout(() => {
                scanAndLoadResources();
              }, 100);
            };
            
          } catch (error) {
            console.error('Failed to load page:', error);
            showError('Failed to load page: ' + error.message + '\n\nCheck console for details.');
          }
        }

        function showError(msg) {
          document.body.innerHTML = '<div class="error">' + msg + '</div>';
        }

        // Expose navigation function
        window.handleProxyNavigation = async function(targetUrl) {
          console.log('Handling navigation to:', targetUrl);
          loading.style.display = 'flex';
          iframe.style.display = 'none';
          updateStatus('Loading...');
          
          try {
            await loadPageFromUrl(targetUrl);
          } catch (error) {
            console.error('Navigation failed:', error);
            showError('Failed to navigate: ' + error.message);
          }
        };

        // Scan and load all resources
        async function scanAndLoadResources() {
          if (!iframe.contentDocument) {
            console.error('Cannot access iframe content');
            return;
          }

          console.log('Scanning for resources to load...');
          
          // Load images
          const images = iframe.contentDocument.querySelectorAll('img[data-proxy-src]');
          console.log('Found', images.length, 'images to load');
          for (let i = 0; i < images.length; i++) {
            const img = images[i];
            const imgUrl = img.getAttribute('data-proxy-src');
            if (!imgUrl) continue;
            
            try {
              console.log('Loading image:', imgUrl);
              const result = await proxyRequest(imgUrl);
              const contentType = result.contentType || 'image/png';
              img.src = `data:${contentType};base64,${result.data}`;
            } catch (error) {
              console.error('Failed to load image:', imgUrl, error);
            }
          }
          
          // Load stylesheets
          const links = iframe.contentDocument.querySelectorAll('link[data-proxy-href]');
          console.log('Found', links.length, 'stylesheets to load');
          for (let i = 0; i < links.length; i++) {
            const link = links[i];
            const cssUrl = link.getAttribute('data-proxy-href');
            if (!cssUrl) continue;
            
            try {
              console.log('Loading stylesheet:', cssUrl);
              const result = await proxyRequest(cssUrl);
              const cssContent = base64DecodeUnicode(result.data);
              
              const style = iframe.contentDocument.createElement('style');
              style.textContent = cssContent;
              link.parentNode.insertBefore(style, link.nextSibling);
            } catch (error) {
              console.error('Failed to load stylesheet:', cssUrl, error);
            }
          }
          
          // Load scripts
          const scripts = iframe.contentDocument.querySelectorAll('script[data-proxy-src]');
          console.log('Found', scripts.length, 'scripts to load');
          for (let i = 0; i < scripts.length; i++) {
            const script = scripts[i];
            const scriptUrl = script.getAttribute('data-proxy-src');
            if (!scriptUrl) continue;
            
            try {
              console.log('Loading script:', scriptUrl);
              const result = await proxyRequest(scriptUrl);
              const jsContent = base64DecodeUnicode(result.data);
              
              const newScript = iframe.contentDocument.createElement('script');
              newScript.textContent = jsContent;
              script.parentNode.replaceChild(newScript, script);
            } catch (error) {
              console.error('Failed to load script:', scriptUrl, error);
            }
          }
          
          console.log('Finished loading resources');
        }

        // Expose fetch proxy for iframe
        window.handleProxyFetch = async function(url, method, headers, body) {
          console.log('Handling proxy fetch:', url);
          try {
            const result = await proxyRequest(url, method, headers, body);
            return {
              success: true,
              status: result.status,
              statusText: result.statusText,
              headers: result.headers,
              data: result.data,
              contentType: result.contentType
            };
          } catch (error) {
            console.error('Proxy fetch error:', error);
            return {
              success: false,
              error: error.message
            };
          }
        };

        function injectProxyIntoHtml(html, baseUrl) {
          const proxyScript = `
            <script>
            (function() {
              console.log('Proxy script initializing...');
              const baseUrl = '${baseUrl.replace(/'/g, "\\'")}';
              
              // Override fetch to use parent's proxy
              const originalFetch = window.fetch;
              window.fetch = async function(resource, init = {}) {
                const url = typeof resource === 'string' ? resource : resource.url;
                let absoluteUrl;
                try {
                  absoluteUrl = new URL(url, baseUrl).href;
                } catch (e) {
                  absoluteUrl = url;
                }
                
                console.log('Proxying fetch:', absoluteUrl);
                
                try {
                  const result = await window.parent.handleProxyFetch(
                    absoluteUrl,
                    init.method || 'GET',
                    init.headers || {},
                    init.body
                  );
                  
                  if (!result.success) {
                    throw new Error(result.error);
                  }
                  
                  const binaryString = atob(result.data);
                  const bytes = new Uint8Array(binaryString.length);
                  for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                  }
                  const blob = new Blob([bytes], { type: result.contentType });
                  
                  return new Response(blob, {
                    status: result.status,
                    statusText: result.statusText,
                    headers: result.headers
                  });
                } catch (error) {
                  console.error('Fetch error:', error);
                  throw error;
                }
              };
              
              // Intercept link clicks
              document.addEventListener('click', function(e) {
                let target = e.target;
                while (target && target.tagName !== 'A') {
                  target = target.parentElement;
                }
                
                if (!target) return;
                
                const href = target.getAttribute('href');
                if (!href || href.startsWith('#') || href.startsWith('javascript:') || 
                    href.startsWith('mailto:') || href.startsWith('tel:')) {
                  return;
                }
                
                try {
                  const linkUrl = new URL(href, baseUrl);
                  const baseUrlObj = new URL(baseUrl);
                  
                  if (linkUrl.origin === baseUrlObj.origin) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Intercepted link click:', linkUrl.href);
                    
                    if (window.parent && window.parent.handleProxyNavigation) {
                      window.parent.handleProxyNavigation(linkUrl.href);
                    }
                  }
                } catch (err) {
                  console.error('Failed to process link:', href, err);
                }
              }, true);
              
              // Mark resources for parent to load
              function markResources() {
                console.log('Marking resources for loading');
                
                // Mark images
                document.querySelectorAll('img[src]').forEach(img => {
                  const src = img.getAttribute('src');
                  if (src && !src.startsWith('data:') && !src.startsWith('blob:')) {
                    try {
                      const absoluteUrl = new URL(src, baseUrl).href;
                      img.setAttribute('data-proxy-src', absoluteUrl);
                      img.removeAttribute('src');
                    } catch (e) {
                      console.error('Failed to process image:', src, e);
                    }
                  }
                });
                
                // Mark stylesheets
                document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                  const href = link.getAttribute('href');
                  if (href && !href.startsWith('data:') && !href.startsWith('blob:')) {
                    try {
                      const absoluteUrl = new URL(href, baseUrl).href;
                      link.setAttribute('data-proxy-href', absoluteUrl);
                      link.removeAttribute('href');
                    } catch (e) {
                      console.error('Failed to process stylesheet:', href, e);
                    }
                  }
                });
                
                // Mark scripts
                document.querySelectorAll('script[src]').forEach(script => {
                  const src = script.getAttribute('src');
                  if (src && !src.startsWith('data:') && !src.startsWith('blob:')) {
                    try {
                      const absoluteUrl = new URL(src, baseUrl).href;
                      script.setAttribute('data-proxy-src', absoluteUrl);
                      script.removeAttribute('src');
                    } catch (e) {
                      console.error('Failed to process script:', src, e);
                    }
                  }
                });
                
                console.log('Resources marked');
              }
              
              if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', markResources);
              } else {
                markResources();
              }
              
              console.log('Proxy script initialized');
            })();
            </` + `script>`;
          
          if (html.includes('</head>')) {
            return html.replace('</head>', proxyScript + '</head>');
          } else if (html.includes('<body')) {
            return html.replace(/<body([^>]*)>/, '<body$1>' + proxyScript);
          } else {
            return proxyScript + html;
          }
        }

        console.log('Starting page load for:', url);
        loadPage();
      }
    </script>
  </body>
</html>